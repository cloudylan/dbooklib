<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="http://localhost/dbooklib/css/bootstrap.min.css">
    <!-- <link rel="stylesheet" href="./css/bootstrap.min.css"> -->
    <title>数据</title>

    <style>
        .body {
            font-family: "SF Pro SC", "SF Pro Text", "SF Pro Icons", "PingFang SC",
                "Helvetica Neue", "Helvetica", "Arial", sans-serif;
        }

        .dlib-analysis-container {
            margin-top: 2px;
            margin-bottom: 2px;
        }

        .dlib-analysis-main {
            margin-top: 2em;
        }

        .dlib-analysis-main-left-readnum {
            padding-left: 8%;
        }

        .dlib-analysis-author {
            width: 95%;
            margin-right: 2em;
        }

        .dlib-analysis-authors{
            margin-top: 1em;
            margin-right: 4%;
            width: 80%;
        }
    </style>
</head>

<body>
    <div class="dlib-analysis-container">
        <!-- Image and text -->
        <nav class="navbar navbar-light bg-light">
            <a class="navbar-brand" href="/dbooklib/">
                <!-- <img src="./pics/sailor.jpg" width="30" height="30" class="d-inline-block align-top"
                    alt=""><span>阅读数据</span> -->
                <img src="http://localhost:8080/dbooklib/pics/sailor.jpg" width="30" height="30"
                    class="d-inline-block align-top" alt=""><span>阅读数据</span>
            </a>
        </nav>
        <div class="dlib-analysis-main row">
            <div class="dlib-analysis-main-left col-sm-2">
                <div class="dlib-analysis-main-left-readnum">
                    <div class="card border-success mb-1" style="max-width: 8rem;">
                        <div class="card-header">已读</div>
                        <div class="card-body text-success">
                            <p class="card-text" th:text="${readStats.read}">100</p>
                        </div>
                    </div>
                    <div class="card border-danger mb-1" style="max-width: 8rem;">
                        <div class="card-header">未读</div>
                        <div class="card-body text-danger">
                            <p class="card-text" th:text="${readStats.notRead}">100</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="dlib-analysis-main-middle col-sm-7">
                <div id="analysis-year-chart" class="analysis-year-chart">
                </div>
                <div id="analysis-category-chart">
                </div>
                <div id="analysis-oneyear-chart">
                </div>
            </div>
            <div class="dlib-analysis-main-right col-sm-3">
                <h5>读过的作者</h5>
                <div id="dlib-analysis-authors" class="dlib-analysis-authors">
                    <ul id="dlib-analysis-author-list" class="list-group">
                    </ul>
                </div>
                <div id="dlib-analysis-author-tops">
                    <div class="card mb-3 dlib-analysis-author">
                        <div class="row no-gutters">
                            <div class="col-md-5">
                                <img src="http://localhost/pics/author/asimov.jpg" class="card-img" alt="...">
                            </div>
                            <div class="col-md-7">
                                <div class="card-body">
                                    <h6 class="card-title">艾萨克·阿西莫夫</h6>
                                    <p class="card-text"><small class="text-muted">6</small></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3 dlib-analysis-author">
                        <div class="row no-gutters">
                            <div class="col-md-5">
                                <img src="http://localhost/pics/author/neilgaiman.jpg" class="card-img" alt="...">
                            </div>
                            <div class="col-md-7">
                                <div class="card-body">
                                    <h6 class="card-title">尼尔·盖曼</h6>
                                    <p class="card-text"><small class="text-muted">5</small></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3 dlib-analysis-author">
                        <div class="row no-gutters">
                            <div class="col-md-5">
                                <img src="http://localhost/pics/author/liucixin.jpg" class="card-img" alt="...">
                            </div>
                            <div class="col-md-7">
                                <div class="card-body">
                                    <h6 class="card-title">刘慈欣</h6>
                                    <p class="card-text"><small class="text-muted">4</small></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- <script src="./js/jquery-3.4.1.js"></script>
    <script src="./js/popper.min.js"></script>
    <script src="./js/bootstrap.min.js"></script> -->
    <script src="http://localhost/dbooklib/js/jquery-3.4.1.js"></script>
    <script src="http://localhost/dbooklib/js/popper.min.js"></script>
    <script src="http://localhost/dbooklib/js/bootstrap.min.js"></script>
    <script src="http://localhost/dbooklib/js/highcharts.js"></script>
    <script src="http://localhost/static/js/highcharts-more.js"></script>
    <script src="https://code.highcharts.com.cn/highcharts/modules/exporting.js"></script>
    <script src="https://code.highcharts.com.cn/highcharts/modules/heatmap.js"></script>
    <script src="https://code.highcharts.com.cn/highcharts/modules/oldie.js"></script>
    <script src="https://code.highcharts.com.cn/highcharts/modules/tilemap.js"></script>
    <script type="text/javascript">
        meta = {
            host: 'http://localhost:8080/dbooklib/',
            yearLabels: [],
            yearStats: { name: '全部', data: [] },
            toDos: 0
        }

        $(function () {

            $.ajax(meta.host + 'rest/analysis/year', {
                method: 'GET',
                dataType: 'html',
                headers: {
                    "Content-Type": "application/json"
                },
                success: function (response) {
                    var $content = JSON.parse(response)
                    for (var i = 0; i < $content.length; i++) {
                        if ($content[i]._id == null) {
                            meta.toDos = $content[i].count
                            continue
                        }
                        meta.yearLabels[i] = $content[i]._id
                        meta.yearStats.data[i] = $content[i].count
                    }

                    console.log(meta.yearLabels)
                    Highcharts.chart('analysis-year-chart', {
                        chart: {
                            type: 'column'
                        },
                        title: {
                            text: '读书年分布'
                        },
                        // subtitle: {
                        //     text: 'Source: WorldClimate.com'
                        // },
                        xAxis: {
                            categories: meta.yearLabels,
                            crosshair: true
                        },
                        yAxis: {
                            min: 0,
                            title: {
                                text: ''
                            }
                        },
                        tooltip: {
                            headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                            pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                                '<td style="padding:0"><b>{point.y} 本</b></td></tr>',
                            footerFormat: '</table>',
                            shared: true,
                            useHTML: true
                        },
                        plotOptions: {
                            column: {
                                pointPadding: 0.2,
                                borderWidth: 0
                            }
                        },
                        series: [meta.yearStats]
                    });
                }
            })

            $.ajax(meta.host + 'rest/analysis/category', {
                method: 'GET',
                dataType: 'html',
                headers: { "Content-Type": "application/json" },
                success: function (response) {
                    var myDate = new Date();
                    var tYear = myDate.getFullYear();
                    var dividence = tYear - 2000
                    var maxValue = 0

                    $content = JSON.parse(response)
                    var current_year = $content[String(tYear)]
                    var previous_year = $content[String(tYear - 1)]
                    var history = $content['history']

                    var all_type = []
                    var history_count = [0, 0, 0, 0, 0]
                    var current_year_count = [0, 0, 0, 0, 0]
                    var previous_year_count = [0, 0, 0, 0, 0]

                    var loopData = (category_data, target_count) => {
                        for (var j = 0; j < category_data.length; j++) {
                            if (category_data[j].count > maxValue)
                                maxValue = category_data[j].count

                            // console.log(category_data[j]._id )
                            if (category_data[j]._id == '历史')
                                target_count[0] = category_data[j].count
                            else if (category_data[j]._id == '文学')
                                target_count[1] = category_data[j].count
                            else if (category_data[j]._id == '漫画')
                                target_count[2] = category_data[j].count
                            else if (category_data[j]._id == '计算机')
                                target_count[3] = category_data[j].count
                            else if (category_data[j]._id == '论述')
                                target_count[4] = category_data[j].count
                        }
                    }

                    for (var i = 0; i < history.length; i++) {
                        all_type[i] = history[i]._id
                        history_count[i] = history[i].count / dividence
                        if (history_count[i] > maxValue)
                            maxValue = history_count[i]
                    }

                    loopData(current_year, current_year_count)
                    loopData(previous_year, previous_year_count)

                    Highcharts.chart('analysis-category-chart', {

                        chart: {
                            polar: true,
                            type: 'line'
                        },

                        accessibility: {
                            description: '读书种类对比，今年 vs 历史。'
                        },

                        title: {
                            text: '类别分布',
                            x: -80
                        },

                        pane: {
                            size: '85%'
                        },

                        xAxis: {
                            categories: all_type,
                            tickmarkPlacement: 'on',
                            lineWidth: 0
                        },

                        yAxis: {
                            gridLineInterpolation: 'polygon',
                            lineWidth: 0,
                            softMin: 5,
                            softMax: 5,
                            endOnTick: false
                        },

                        tooltip: {
                            shared: true,
                            pointFormat: '<span style="color:{series.color}">{series.name}: <b>{point.y}</b><br/>'
                        },

                        legend: {
                            align: 'right',
                            verticalAlign: 'middle'
                        },

                        series: [{
                            name: '今年',
                            data: current_year_count,
                            color: '#53E30F',
                            pointPlacement: 'on'
                        }, {
                            name: '去年',
                            data: previous_year_count,
                            color: '#1DBDE5',
                            pointPlacement: 'on'
                        }, {
                            name: '历史记录',
                            data: history_count,
                            color: '#E44532',
                            pointPlacement: 'on'
                        }],

                        responsive: {
                            rules: [{
                                condition: {
                                    maxWidth: 500
                                },
                                chartOptions: {
                                    legend: {
                                        align: 'center',
                                        verticalAlign: 'bottom'
                                    },
                                    pane: {
                                        size: '100%'
                                    }
                                }
                            }]
                        }

                    });
                }
            })

            Highcharts.chart('analysis-oneyear-chart', {
                chart: {
                    type: 'tilemap',
                    inverted: true,
                    height: '80%'
                },

                accessibility: {
                    description: 'A tile map represents the states of the USA by population in 2016. The hexagonal tiles are positioned to geographically echo the map of the USA. A color-coded legend states the population levels as below 1 million (beige), 1 to 5 million (orange), 5 to 20 million (pink) and above 20 million (hot pink). The chart is interactive, and the individual state data points are displayed upon hovering. Three states have a population of above 20 million: California (39.3 million), Texas (27.9 million) and Florida (20.6 million). The northern US region from Massachusetts in the Northwest to Illinois in the Midwest contains the highest concentration of states with a population of 5 to 20 million people. The southern US region from South Carolina in the Southeast to New Mexico in the Southwest contains the highest concentration of states with a population of 1 to 5 million people. 6 states have a population of less than 1 million people; these include Alaska, Delaware, Wyoming, North Dakota, South Dakota and Vermont. The state with the lowest population is Wyoming in the Northwest with 584,153 people.'
                },

                title: {
                    text: 'U.S. states by population in 2016'
                },

                subtitle: {
                    text: 'Source:<a href="https://simple.wikipedia.org/wiki/List_of_U.S._states_by_population">Wikipedia</a>'
                },

                xAxis: {
                    visible: false
                },

                yAxis: {
                    visible: false
                },

                colorAxis: {
                    dataClasses: [{
                        from: 0,
                        to: 1000000,
                        color: '#F9EDB3',
                        name: '< 1M'
                    }, {
                        from: 1000000,
                        to: 5000000,
                        color: '#FFC428',
                        name: '1M - 5M'
                    }, {
                        from: 5000000,
                        to: 20000000,
                        color: '#FF7987',
                        name: '5M - 20M'
                    }, {
                        from: 20000000,
                        color: '#FF2371',
                        name: '> 20M'
                    }]
                },

                tooltip: {
                    headerFormat: '',
                    pointFormat: 'The population of <b> {point.name}</b> is <b>{point.value}</b>'
                },

                plotOptions: {
                    series: {
                        dataLabels: {
                            enabled: true,
                            format: '{point.hc-a2}',
                            color: '#000000',
                            style: {
                                textOutline: false
                            }
                        }
                    }
                },

                series: [{
                    name: '',
                    data: [{
                        'hc-a2': 'Python',
                        name: 'Alabama',
                        region: 'South',
                        x: 6,
                        y: 7,
                        value: 4849377
                    }, {
                        'hc-a2': 'AK',
                        name: 'Alaska',
                        region: 'West',
                        x: 0,
                        y: 0,
                        value: 737732
                    }, {
                        'hc-a2': 'AZ',
                        name: 'Arizona',
                        region: 'West',
                        x: 5,
                        y: 3,
                        value: 6745408
                    }, {
                        'hc-a2': 'AR',
                        name: 'Arkansas',
                        region: 'South',
                        x: 5,
                        y: 6,
                        value: 2994079
                    }, {
                        'hc-a2': 'CA',
                        name: 'California',
                        region: 'West',
                        x: 5,
                        y: 2,
                        value: 39250017
                    }, {
                        'hc-a2': 'CO',
                        name: 'Colorado',
                        region: 'West',
                        x: 4,
                        y: 3,
                        value: 5540545
                    }, {
                        'hc-a2': 'CT',
                        name: 'Connecticut',
                        region: 'Northeast',
                        x: 3,
                        y: 11,
                        value: 3596677
                    }, {
                        'hc-a2': 'DE',
                        name: 'Delaware',
                        region: 'South',
                        x: 4,
                        y: 9,
                        value: 935614
                    }, {
                        'hc-a2': 'DC',
                        name: 'District of Columbia',
                        region: 'South',
                        x: 4,
                        y: 10,
                        value: 7288000
                    }, {
                        'hc-a2': 'FL',
                        name: 'Florida',
                        region: 'South',
                        x: 8,
                        y: 8,
                        value: 20612439
                    }, {
                        'hc-a2': 'GA',
                        name: 'Georgia',
                        region: 'South',
                        x: 7,
                        y: 8,
                        value: 10310371
                    }, {
                        'hc-a2': 'HI',
                        name: 'Hawaii',
                        region: 'West',
                        x: 8,
                        y: 0,
                        value: 1419561
                    }, {
                        'hc-a2': 'ID',
                        name: 'Idaho',
                        region: 'West',
                        x: 3,
                        y: 2,
                        value: 1634464
                    }, {
                        'hc-a2': 'IL',
                        name: 'Illinois',
                        region: 'Midwest',
                        x: 3,
                        y: 6,
                        value: 12801539
                    }, {
                        'hc-a2': 'IN',
                        name: 'Indiana',
                        region: 'Midwest',
                        x: 3,
                        y: 7,
                        value: 6596855
                    }, {
                        'hc-a2': 'IA',
                        name: 'Iowa',
                        region: 'Midwest',
                        x: 3,
                        y: 5,
                        value: 3107126
                    }, {
                        'hc-a2': 'KS',
                        name: 'Kansas',
                        region: 'Midwest',
                        x: 5,
                        y: 5,
                        value: 2904021
                    }, {
                        'hc-a2': 'KY',
                        name: 'Kentucky',
                        region: 'South',
                        x: 4,
                        y: 6,
                        value: 4413457
                    }, {
                        'hc-a2': 'LA',
                        name: 'Louisiana',
                        region: 'South',
                        x: 6,
                        y: 5,
                        value: 4649676
                    }, {
                        'hc-a2': 'ME',
                        name: 'Maine',
                        region: 'Northeast',
                        x: 0,
                        y: 11,
                        value: 1330089
                    }, {
                        'hc-a2': 'MD',
                        name: 'Maryland',
                        region: 'South',
                        x: 4,
                        y: 8,
                        value: 6016447
                    }, {
                        'hc-a2': 'MA',
                        name: 'Massachusetts',
                        region: 'Northeast',
                        x: 2,
                        y: 10,
                        value: 6811779
                    }, {
                        'hc-a2': 'MI',
                        name: 'Michigan',
                        region: 'Midwest',
                        x: 2,
                        y: 7,
                        value: 9928301
                    }, {
                        'hc-a2': 'MN',
                        name: 'Minnesota',
                        region: 'Midwest',
                        x: 2,
                        y: 4,
                        value: 5519952
                    }, {
                        'hc-a2': 'MS',
                        name: 'Mississippi',
                        region: 'South',
                        x: 6,
                        y: 6,
                        value: 2984926
                    }, {
                        'hc-a2': 'MO',
                        name: 'Missouri',
                        region: 'Midwest',
                        x: 4,
                        y: 5,
                        value: 6093000
                    }, {
                        'hc-a2': 'MT',
                        name: 'Montana',
                        region: 'West',
                        x: 2,
                        y: 2,
                        value: 1023579
                    }, {
                        'hc-a2': 'NE',
                        name: 'Nebraska',
                        region: 'Midwest',
                        x: 4,
                        y: 4,
                        value: 1881503
                    }, {
                        'hc-a2': 'NV',
                        name: 'Nevada',
                        region: 'West',
                        x: 4,
                        y: 2,
                        value: 2839099
                    }, {
                        'hc-a2': 'NH',
                        name: 'New Hampshire',
                        region: 'Northeast',
                        x: 1,
                        y: 11,
                        value: 1326813
                    }, {
                        'hc-a2': 'NJ',
                        name: 'New Jersey',
                        region: 'Northeast',
                        x: 3,
                        y: 10,
                        value: 8944469
                    }, {
                        'hc-a2': 'NM',
                        name: 'New Mexico',
                        region: 'West',
                        x: 6,
                        y: 3,
                        value: 2085572
                    }, {
                        'hc-a2': 'NY',
                        name: 'New York',
                        region: 'Northeast',
                        x: 2,
                        y: 9,
                        value: 19745289
                    }, {
                        'hc-a2': 'NC',
                        name: 'North Carolina',
                        region: 'South',
                        x: 5,
                        y: 9,
                        value: 10146788
                    }, {
                        'hc-a2': 'ND',
                        name: 'North Dakota',
                        region: 'Midwest',
                        x: 2,
                        y: 3,
                        value: 739482
                    }, {
                        'hc-a2': 'OH',
                        name: 'Ohio',
                        region: 'Midwest',
                        x: 3,
                        y: 8,
                        value: 11614373
                    }, {
                        'hc-a2': 'OK',
                        name: 'Oklahoma',
                        region: 'South',
                        x: 6,
                        y: 4,
                        value: 3878051
                    }, {
                        'hc-a2': 'OR',
                        name: 'Oregon',
                        region: 'West',
                        x: 4,
                        y: 1,
                        value: 3970239
                    }, {
                        'hc-a2': 'PA',
                        name: 'Pennsylvania',
                        region: 'Northeast',
                        x: 3,
                        y: 9,
                        value: 12784227
                    }, {
                        'hc-a2': 'RI',
                        name: 'Rhode Island',
                        region: 'Northeast',
                        x: 2,
                        y: 11,
                        value: 1055173
                    }, {
                        'hc-a2': 'SC',
                        name: 'South Carolina',
                        region: 'South',
                        x: 6,
                        y: 8,
                        value: 4832482
                    }, {
                        'hc-a2': 'SD',
                        name: 'South Dakota',
                        region: 'Midwest',
                        x: 3,
                        y: 4,
                        value: 853175
                    }, {
                        'hc-a2': 'TN',
                        name: 'Tennessee',
                        region: 'South',
                        x: 5,
                        y: 7,
                        value: 6651194
                    }, {
                        'hc-a2': 'TX',
                        name: 'Texas',
                        region: 'South',
                        x: 7,
                        y: 4,
                        value: 27862596
                    }, {
                        'hc-a2': 'UT',
                        name: 'Utah',
                        region: 'West',
                        x: 5,
                        y: 4,
                        value: 2942902
                    }, {
                        'hc-a2': 'VT',
                        name: 'Vermont',
                        region: 'Northeast',
                        x: 1,
                        y: 10,
                        value: 626011
                    }, {
                        'hc-a2': 'VA',
                        name: 'Virginia',
                        region: 'South',
                        x: 5,
                        y: 8,
                        value: 8411808
                    }, {
                        'hc-a2': 'WA',
                        name: 'Washington',
                        region: 'West',
                        x: 2,
                        y: 1,
                        value: 7288000
                    }, {
                        'hc-a2': 'WV',
                        name: 'West Virginia',
                        region: 'South',
                        x: 4,
                        y: 7,
                        value: 1850326
                    }, {
                        'hc-a2': 'WI',
                        name: 'Wisconsin',
                        region: 'Midwest',
                        x: 2,
                        y: 5,
                        value: 5778708
                    }, {
                        'hc-a2': 'WY',
                        name: 'Wyoming',
                        region: 'West',
                        x: 3,
                        y: 3,
                        value: 584153
                    }]
                }]
            });

            $.ajax(meta.host + 'rest/analysis/author', {
                method: 'GET',
                dataType: 'html',
                headers: {
                    "Content-Type": "application/json"
                },
                success: function (response) {
                    content = JSON.parse(response)
                    console.log(content)
                    $list = $('#dlib-analysis-author-list')

                    $.each(content, function (index, value) {
                        $li = $('<li class="list-group-item d-flex justify-content-between align-items-center"></li>')
                        $li.html(value._id)
                        $num = $('<span class="badge badge-primary badge-pill"></span>')
                        $num.html(value.count)
                        $li.append($num)
                        $list.append($li)
                    })
                }
            })

            const initPage = () => {
                $('#dlib-analysis-author-tops').hide()
            }

            initPage()
        })

    </script>
</body>

</html>